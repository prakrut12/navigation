<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GMU Campus Navigation - Enhanced with Building Images</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(to right, #651e21, #5b1f1f);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background:linear-gradient(to right, #651e21, #5b1f1f) ; 
            
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        header {
            background: linear-gradient(to right, #651e21, #5b1f1f);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }
        
        .logo {
            position: absolute;
            left: 20px;
            top: 15px;
            font-size: 24px;
            font-weight: bold;
        }
        
        h1 {
            margin: 0;
            font-size: 28px;
        }
        
        .subtitle {
            font-size: 16px;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .search-section {
            padding: 20px;
            background: linear-gradient(to left, #ecc35c, #f7f3b7, #ecc35c);
            border-bottom: linear-gradient(to left, #ecc35c, #f7f3b7, #ecc35c);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }
        
        .input-group {
            flex: 1;
            min-width: 250px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color:linear-gradient(to right, #651e21, #5b1f1f);
        }
        
        .input-group input, .input-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #ccc;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .input-group input:focus, .input-group select:focus {
            border-color: linear-gradient(to right, #651e21, #5b1f1f);
            outline: none;
        }
        
        .search-btn {
            align-self: flex-end;
            background: linear-gradient(to right, #651e21, #5b1f1f);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: background 0.3s;
        }
        
        .search-btn:hover {
            background:linear-gradient(to right, #651e21, #5b1f1f);
        }
        
        .voice-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 15px;
        }
        
        .voice-btn {
            background: linear-gradient(to right, #651e21, #5b1f1f);
            color:white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .voice-btn:hover {
            background:linear-gradient(to right, #651e21, #5b1f1f);
        }
        
        .voice-btn.listening {
            background: green;
            animation: pulse 1.5s infinite;
        }
        
        .voice-btn.speaking {
            background: #5b1f1f;
            animation: pulse 1.5s infinite;
        }
        
        .voice-status {
            font-size: 14px;
            color: #666;
            max-width: 150px;
        }
        
        .map-section {
            padding: 20px;
            position: relative;
        }
        
        .map-title {
            margin-bottom: 15px;
            color: #ffffff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .map-controls {
            display: flex;
            gap: 10px;
        }
        
        .control-btn {
            padding: 8px 15px;
            background: #e9ecf5;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .control-btn:hover {
            background:linear-gradient(to left, #ecc35c, #f7f3b7, #ecc35c);
            color: black;
        }
        
        .map-container {
            height: 600px;
            background:linear-gradient(to left, #ecc35c, #f7f3b7, #ecc35c);
            border-radius: 10px;
            overflow: auto;
            position: relative;
            border: 1px solid #5b1f1f;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .floor-map {
            width: 2000px;
            height: 1850px;
            
            position: relative;
            transform-origin: center center;
            margin: auto;
        }
        
        
        .node {
            position: absolute;
            background: white;
            border: 2px solid #5b1f1f;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 0;
            text-align: center;
            width: 140px;
            height: 140px;
            z-index: 10;
            overflow: hidden;
        }
        
        .node:hover {
            background: #e9ecf5;
            transform: scale(1.05);
            z-index: 20;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .node.stairs {
            background: #d4e6ff;
            font-weight: bold;
        }
        
        .node.lab {
            background: #ffe6cc;
        }
        
        .node-name {
            font-weight: bold;
            color: #5b1f1f;
            font-size: 12px;
            line-height: 1.2;
            padding: 2px 4px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 3px;
            margin-top: 2px;
            position: absolute;
            bottom: 2px;
            left: 2px;
            right: 2px;
            text-align: center;
        }
        
        .building-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 3px;
        }
        
        .connection {
            position: absolute;
            background: #888;
            height: 3px;
            transform-origin: 0 0;
            z-index: 1;
        }
        
        .connection.horizontal {
            height: 3px;
        }
        
        .connection.vertical {
            width: 3px;
        }
        
        .current-position {
            background:blue;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            position: absolute;
            z-index: 100;
            box-shadow:0 0 0 3px rgba(64, 12, 169, 0.4);
            animation: pulse 2s infinite;
        }
        
        .destination {
            background:  #4caf50;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            position: absolute;
            z-index: 100;
            box-shadow: 0 0 0 3px rgba(7, 43, 16, 0.4);
        }
        
        .route-path {
            position: absolute;
            background: #5b1f1f;
            z-index: 5;
            height: 6px;
            border-radius: 3px;
            transform-origin: 0 0;
        }
        
        .route-path.horizontal {
            height: 6px;
        }
        
        .route-path.vertical {
            width: 6px;
        }
        
        .direction-marker {
            position: absolute;
            background:  #651e21 ;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            z-index: 95;
            animation: bounce 1s infinite alternate;
            font-size: 12px;
        }
        
        .avatar {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgb(94, 94, 236);
            z-index: 200;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 16px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            transition: all 0.5s ease-out;
        }
        
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 200;
        }
        
        .zoom-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(to right, #651e21, #5b1f1f);
            color: white;
            border: none;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .instructions {
            background: #fffaf0; /* Changed to a solid light color for readability */
            padding: 15px;
            border-radius: 10px;
            margin: 15px;
            border-left: 5px solid #651e21;
        }
        
        .instructions h3 {
            color: #5b1f1f; /* Gradient is not valid for color */
            margin-bottom: 10px;
        }
        
        .instructions ul {
            padding-left: 20px;
        }
        
        .instructions li {
            margin-bottom: 8px;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            background:linear-gradient(to right, #651e21, #5b1f1f);
            color: white;
            font-size: 14px;
        }
        
        @keyframes pulse {
            0% { opacity: 0.7; transform: scale(1); }
            50% { opacity: 1; transform: scale(1.1); }
            100% { opacity: 0.7; transform: scale(1); }
        }
        
        @keyframes bounce {
            from { transform: translateY(0); }
            to { transform: translateY(-5px); }
        }
        
        @keyframes walk {
            0% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0); }
        }
        
        @media (max-width: 968px) {
            .search-section {
                flex-direction: column;
            }
            
            .floor-map {
                width: 800px;
                height: 600px;
            }
            
            .voice-control {
                margin-left: 0;
                margin-top: 15px;
            }
        }
        
        .voice-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(to left, #ecc35c, #ecc35c, #ecc35c);
            color: black;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 300px;
            opacity: 0;
            transform: translateY(-20px);
            transition: opacity 0.3s, transform 0.3s;
        }
        
        .voice-notification.show {
            opacity: 1;
            transform: translateY(0);
        }
        
        .voice-notification.error {
            background: linear-gradient(to left, #ecc35c, #f7f3b7, #ecc35c);
        }
        
        .voice-notification.success {
            background: rgba(76, 175, 80, 0.9);
        }
        
        .voice-settings {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-left: 15px;
        }
        
        .voice-toggle {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        
        input:checked + .slider {
            background-color: #5b1f1f;
        }
        
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        
        /* Building Info Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }
        
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 80%;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 10px;
        }
        
        .close-modal:hover {
            color: #000;
        }
        
        .building-info {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .building-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .building-image {
            width: 200px;
            height: 150px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .building-title {
            color: #5b1f1f;
            font-size: 24px;
        }
        
        .building-description {
            color: #555;
            line-height: 1.6;
        }
        
        .floors-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .floor-card {
            background: #f5f7ff;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .floor-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .floor-image {
            width: 100%;
            height: 120px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 10px;
        }
        
        .floor-name {
            font-weight: bold;
            color:#5b1f1f ;
            margin-bottom: 5px;
        }
        
        .node-with-image {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px;
        }
        
        .node-image {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 5px;
            margin-bottom: 5px;
        }
        
        /* Basement Floor Modal Styles */
        .basement-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.9);
            overflow: auto;
        }
        
        .basement-content {
            background-color: #fefefe;
            margin: 20px auto;
            padding: 20px;
            border-radius: 10px;
            width: 95%;
            max-width: 1200px;
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .close-basement {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            right: 20px;
            top: 10px;
            z-index: 1001;
        }
        
        .close-basement:hover {
            color: #000;
        }
        
        .basement-header {
            text-align: center;
            margin:#5b1f1f;
        }
        
        .basement-container {
            height: 600px;
            background:linear-gradient(to left, #ecc35c, #f7f3b7, #ecc35c);
            border-radius: 10px;
            overflow: auto;
            position: relative;
            border: 1px solid #5b1f1f;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .basement-map {
            width: 1200px;
            height: 1200px;
            background: #e9ecf5;
            position: relative;
            transform-origin: center center;
            margin: auto;
        }
        
        .basement-node {
            position: absolute;
            background: white;
            border: 2px solid #5b1f1f;
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            padding: 0;
            text-align: center;
            width: 100px;
            height: 100px;
            z-index: 10;
            overflow: hidden;
        }
        
        .basement-node:hover {
            background: #e9ecf5;
            transform: scale(1.05);
            z-index: 20;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .basement-node.stairs {
            background: #d4e6ff;
            font-weight: bold;
        }
        
        .basement-node.lab {
            background: #ffe6cc;
        }
        
        .basement-node-name {
            font-weight: bold;
            color: #5b1f1f;
            font-size: 10px;
            line-height: 1.2;
            padding: 2px 4px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 3px;
            margin-top: 2px;
            position: absolute;
            bottom: 2px;
            left: 2px;
            right: 2px;
            text-align: center;
        }
        
        .basement-connection {
            position: absolute;
            background: #888;
            height: 3px;
            transform-origin: 0 0;
            z-index: 1;
        }
        
        .basement-current-position {
            background: blue;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            position: absolute;
            z-index: 100;
            box-shadow: 0 0 0 3px rgba(64, 12, 169, 0.4);
            animation: pulse 2s infinite;
        }
        
        .basement-destination {
            background: #4caf50;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            position: absolute;
            z-index: 100;
            box-shadow: 0 0 0 3px rgba(7, 43, 16, 0.4);
        }
        
        .basement-route-path {
            position: absolute;
            background: #5b1f1f;
            z-index: 5;
            height: 6px;
            border-radius: 3px;
            transform-origin: 0 0;
        }
        
        .basement-direction-marker {
            position: absolute;
            background: #651e21;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            z-index: 95;
            animation: bounce 1s infinite alternate;
            font-size: 12px;
        }
        
        .basement-avatar {
            position: absolute;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: rgb(94, 94, 236);
            z-index: 200;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 16px;
            box-shadow: 0 0 10px rgba(0,0,0,0.3);
            transition: all 0.5s ease-out;
        }
        
        .basement-zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 200;
        }
        
        .basement-zoom-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(to right, #651e21, #5b1f1f);
            color: white;
            border: none;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        
        .basement-controls {
            display: flex;
            gap: 10px;
            margin: 15px 0;
            justify-content: center;
        }
        
        .basement-control-btn {
            padding: 8px 15px;
            background: #e9ecf5;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .basement-control-btn:hover {
            background:linear-gradient(to left, #ecc35c, #f7f3b7, #ecc35c);
            color: black;
        }
    </style>
</head>
<body>
    
        
        
        <div class="search-section">
            <div class="input-group">
                <label for="from">From (Current Location)</label>
                <select id="from">
                    <option value="">-- Select Current Location --</option>
                    <!-- Options will be populated by JavaScript -->
                </select>
            </div>
            
            <div class="input-group">
                <label for="to">To (Destination)</label>
                <select id="to">
                    <option value="">-- Select Destination --</option>
                    <!-- Options will be populated by JavaScript -->
                </select>
            </div>
            
            <button class="search-btn" onclick="calculateRoute()">
                <i class="fas fa-route"></i> Find Route
            </button>
            
            <div class="voice-control">
                <button class="voice-btn" id="voiceBtn" onclick="toggleVoiceRecognition()">
                    <i class="fas fa-microphone"></i>
                </button>
                <div class="voice-status" id="voiceStatus">Voice Navigation</div>
            </div>
            
            <div class="voice-settings">
                <div class="voice-toggle">
                    <span>Voice Guidance:</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="voiceGuidanceToggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
        </div>
        
        
        
        <div class="map-section">
            <div class="map-title">
                <h2>University Campus Map </h2>
                <div class="map-controls">
                    <button class="control-btn" onclick="startGuidance()">
                        <i class="fas fa-play"></i> Start Guidance
                    </button>
                    <button class="control-btn" onclick="stopGuidance()">
                        <i class="fas fa-stop"></i> Stop Guidance
                    </button>
                    <button class="control-btn" onclick="resetView()">
                        <i class="fas fa-sync-alt"></i> Reset View
                    </button>
                </div>
            </div>
            
            <div class="map-container" id="mapContainer">
                <div class="floor-map" id="floorMap">
                    <!-- Map will be drawn by JavaScript -->
                </div>
                
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomIn()">+</button>
                    <button class="zoom-btn" onclick="zoomOut()">-</button>
                </div>
            </div>
        </div>
        
       
    <div class="voice-notification" id="voiceNotification"></div>
    
    <!-- Building Info Modal -->
    <div id="buildingModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" id="closeModal">&times;</span>
            <div id="buildingInfo" class="building-info">
                <!-- Building info will be populated by JavaScript -->
            </div>
        </div>
    </div>
    
    <!-- Engineering Floors Modal -->
    <div id="engFloorModal" class="basement-modal">
        <div class="basement-content">
            <span class="close-basement" id="closeEngFloor">&times;</span>
            <div class="basement-header">
                <h2 id="engFloorTitle">Engineering Block - Floor</h2>
            </div>
            
            <div class="basement-controls">
                <div class="input-group" style="min-width:240px;">
                    <label for="engFrom">From (Current Location)</label>
                    <select id="engFrom">
                        <option value="">-- Select Current Location --</option>
                    </select>
                </div>
                <div class="input-group" style="min-width:240px;">
                    <label for="engTo">To (Destination)</label>
                    <select id="engTo">
                        <option value="">-- Select Destination --</option>
                    </select>
                </div>
                <button class="basement-control-btn" onclick="engFloorCalculateRoute()">
                    <i class="fas fa-route"></i> Find Route
                </button>
            </div>
            
            <div class="basement-controls">
                <button class="basement-control-btn" onclick="engFloorStartGuidance()">
                    <i class="fas fa-play"></i> Start Guidance
                </button>
                <button class="basement-control-btn" onclick="engFloorStopGuidance()">
                    <i class="fas fa-stop"></i> Stop Guidance
                </button>
                <button class="basement-control-btn" onclick="engFloorResetView()">
                    <i class="fas fa-sync-alt"></i> Reset View
                </button>
            </div>
            
            <div class="basement-container" id="engFloorContainer">
                <div class="basement-map" id="engFloorMap">
                    <!-- Engineering floor map will be drawn by JavaScript -->
                </div>
                
                <div class="basement-zoom-controls">
                    <button class="basement-zoom-btn" onclick="engFloorZoomIn()">+</button>
                    <button class="basement-zoom-btn" onclick="engFloorZoomOut()">-</button>
                </div>
            </div>
        </div>
    </div>
    
    
    
    <!-- Basement Floor Modal -->
    <div id="basementModal" class="basement-modal">
        <div class="basement-content">
            <span class="close-basement" id="closeBasement">&times;</span>
            <div class="basement-header">
                <h2>Engineering Block - Basement Floor</h2>
            </div>
            
            <div class="basement-controls">
                <button class="basement-control-btn" onclick="basementStartGuidance()">
                    <i class="fas fa-play"></i> Start Guidance
                </button>
                <button class="basement-control-btn" onclick="basementStopGuidance()">
                    <i class="fas fa-stop"></i> Stop Guidance
                </button>
                <button class="basement-control-btn" onclick="basementResetView()">
                    <i class="fas fa-sync-alt"></i> Reset View
                </button>
            </div>
            
            <div class="basement-container" id="basementContainer">
                <div class="basement-map" id="basementMap">
                    <!-- Basement map will be drawn by JavaScript -->
                </div>
                
                <div class="basement-zoom-controls">
                    <button class="basement-zoom-btn" onclick="basementZoomIn()">+</button>
                    <button class="basement-zoom-btn" onclick="basementZoomOut()">-</button>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Define nodes, edges, and positions on a grid system
        const nodes = [
           "MAIN ENTERANCE", "ENGINEERING BLOCK", "GM INSTITUTE OF PHARMACEUTICAL SCIENCES AND RESEARCH",
            "CENTRAL LIBRARY", "GM BAKERY", "CANTEEN", "LADIES HOSTEL", "GENTS HOSTEL", 
            "GMS ACADEMY DEGREE COLLEGE(BCA,BCom)", "GM HALAMMA PU COLLEGE", "ADMIN BLOCK", 
            "PLAYGROUND", "GANESHA TEMPLE", "FLAG AREA", "CAR PARKING AREA",
            "GUEST HOUSE", "LAWN", "CIRCLE", "BUSTAND AREA",
            // Main road junctions (helper nodes along the straight road)
            "J-GANESHA TEMPLE", "J-ADMIN BLOCK", "J-ENGINEERING BLOCK", "J-CANTEEN",
            "J-LAWN", "J-CAR PARKING AREA", "J-BAKERY", "J-GENTS HOSTEL", "J-LADIES HOSTEL",
            "J-CENTRAL LIBRARY", "J-GUEST HOUSE", "J-PHARMACY", "J-PU", "J-FLAG"
        ];
        
        // Define connections between nodes (using grid coordinates)
        const edges = [
            // Main straight road as chained junctions from MAIN ENTERANCE (y=1150) to CIRCLE (y=150)
            ["MAIN ENTERANCE", "J-GANESHA TEMPLE"],
            ["J-GANESHA TEMPLE", "J-FLAG"],
            ["J-FLAG", "J-ADMIN BLOCK"],
            ["J-GANESHA TEMPLE", "J-ADMIN BLOCK"],
            ["J-ADMIN BLOCK", "J-ENGINEERING BLOCK"],
            ["J-ENGINEERING BLOCK", "J-CANTEEN"],
            ["J-CANTEEN", "J-LAWN"],
            ["J-LAWN", "J-CAR PARKING AREA"],
            ["J-CAR PARKING AREA", "J-BAKERY"],
            ["J-BAKERY", "J-GENTS HOSTEL"],
            ["J-GENTS HOSTEL", "J-LADIES HOSTEL"],
            ["J-LADIES HOSTEL", "J-CENTRAL LIBRARY"],
            ["J-CENTRAL LIBRARY", "J-GUEST HOUSE"],
            ["J-GUEST HOUSE", "J-PHARMACY"],
            ["J-PHARMACY", "CIRCLE"],
            ["CIRCLE", "J-PU"],
            ["ENGINEERING BLOCK","ADMIN BLOCK"],
            ["ENGINEERING BLOCK","GANESHA TEMPLE"],
            ["GANESHA TEMPLE","FLAG AREA"],
            ["ENGINEERING BLOCK","LAWN"],
            ["LAWN","GM BAKERY"],
            ["PLAYGROUND","GUEST HOUSE"],
            ["LADIES HOSTEL","CAR PARKING AREA"],
            // Spokes from buildings to their nearest junction on the main road
            ["GANESHA TEMPLE", "J-GANESHA TEMPLE"],
            ["FLAG AREA", "J-FLAG"],
            ["ADMIN BLOCK", "J-ADMIN BLOCK"],
            ["ENGINEERING BLOCK", "J-ENGINEERING BLOCK"],
            ["CANTEEN", "J-CANTEEN"],
            ["LAWN", "J-LAWN"],
            ["CAR PARKING AREA", "J-CAR PARKING AREA"],
            ["GM BAKERY", "J-BAKERY"],
            ["GENTS HOSTEL", "J-GENTS HOSTEL"],
            ["LADIES HOSTEL", "J-LADIES HOSTEL"],
            ["CENTRAL LIBRARY", "J-CENTRAL LIBRARY"],
            ["GUEST HOUSE", "J-GUEST HOUSE"],
            ["GM INSTITUTE OF PHARMACEUTICAL SCIENCES AND RESEARCH", "J-PHARMACY"],
            ["GM HALAMMA PU COLLEGE", "J-PU"],
            // Locations below the circle branch from the circle point
            ["PLAYGROUND", "CIRCLE"],
            ["BUSTAND AREA", "CIRCLE"]
        ];
    
        // Node positions on a grid (x, y coordinates)
        const nodePositions = {
            "MAIN ENTERANCE": { x: 650, y: 1150 },
            "ENGINEERING BLOCK": { x: 300, y: 700 },
            "GM INSTITUTE OF PHARMACEUTICAL SCIENCES AND RESEARCH": { x: 250, y: 200 },
            "CENTRAL LIBRARY": { x: 500, y: 250 },
            "GM BAKERY": { x: 400, y: 400 },
            "CANTEEN": { x: 900, y: 650 },
            "LADIES HOSTEL": { x: 900, y: 350 },
            "GENTS HOSTEL": { x: 100, y: 500 },
            "GM HALAMMA PU COLLEGE": { x: 400, y: -10 },
            "ADMIN BLOCK": { x: 50, y: 800 },
            "PLAYGROUND": { x: 900, y: -20 },
            "GANESHA TEMPLE": { x: 200, y: 900 },
            "FLAG AREA": { x: 200, y: 1100 },
            "CAR PARKING AREA": { x: 900, y: 500 },
            "GUEST HOUSE": { x: 900, y: 150 },
            "LAWN": { x: 500, y: 550 },
            "CIRCLE": { x: 650, y: 50 },
            "BUSTAND AREA": { x: 900, y: -200 }
        ,
            // Junction positions projected on the main road (x=650) at each building's y
            "J-GANESHA TEMPLE": { x: 650, y: 900 },
            "J-FLAG": { x: 650, y: 1030 },
            "J-ADMIN BLOCK": { x: 650, y: 800 },
            "J-ENGINEERING BLOCK": { x: 650, y: 700 },
            "J-CANTEEN": { x: 650, y: 650 },
            "J-LAWN": { x: 650, y: 550 },
            "J-CAR PARKING AREA": { x: 650, y: 500 },
            "J-BAKERY": { x: 650, y: 400 },
            "J-GENTS HOSTEL": { x: 650, y: 500 },
            "J-LADIES HOSTEL": { x: 650, y: 350 },
            "J-CENTRAL LIBRARY": { x: 650, y: 250 },
            "J-GUEST HOUSE": { x: 650, y: 200 },
            "J-PHARMACY": { x: 650, y: 200 },
            "J-PU": { x: 650, y: 100 }
        };
        
        // Building images - YOU CAN REPLACE THESE WITH YOUR OWN FILE NAMES
        const buildingImages = {
            "ENGINEERING BLOCK": "eng.jpg",
            "CENTRAL LIBRARY": "LIB.jpg",
            "CANTEEN": "cafeteria.jpg",
            "LADIES HOSTEL": "girls hostel.jpg",
            "GENTS HOSTEL": "GENTS HOSTEL.jpg",
            "ADMIN BLOCK": "admin.jpg",
            "PLAYGROUND": "ground.jpg",
            "GUEST HOUSE": "guest.jpg",
            "GM INSTITUTE OF PHARMACEUTICAL SCIENCES AND RESEARCH": "diplamo.jpg",
            "GM HALAMMA PU COLLEGE": "pu.jpg",
            "GMS ACADEMY DEGREE COLLEGE(BCA,BCom)": "pu.jpg",
            "MAIN ENTERANCE": "gmu_Entrance.jpg",
            "GANESHA TEMPLE": "ganesha.jpg",
            "GM BAKERY": "BAKERY.jpg",
            "CAR PARKING AREA": "car.jpg",
            "BUSTAND AREA": "BUS.jpg",
            "LAWN": "LAWN.jpg",
            "CIRCLE": "circle.jpg",
            "FLAG AREA": "flag.jpg"
        };
        
        // Building descriptions
        const buildingDescriptions = {
            "ENGINEERING BLOCK": "The Engineering Block houses various departments including Computer Science, Mechanical, Civil, and Electronics Engineering. It contains state-of-the-art laboratories, classrooms, and faculty offices.",
            "CENTRAL LIBRARY": "The Central Library is a knowledge hub with over 50,000 books, journals, and digital resources. It provides a quiet study environment and group discussion rooms.",
            "CANTEEN": "The campus canteen offers a variety of nutritious and delicious food options at affordable prices. It's a popular spot for students to relax and socialize.",
            "LADIES HOSTEL": "The Ladies Hostel provides safe and comfortable accommodation for female students with amenities like Wi-Fi, common room, and 24/7 security.",
            "GENTS HOSTEL": "The Gents Hostel offers comfortable living spaces for male students with facilities like recreational rooms, study areas, and dining hall.",
            "ADMIN BLOCK": "The Administrative Block houses the university's administrative offices including the Registrar, Finance Department, and Principal's office.",
            "PLAYGROUND": "The university playground features facilities for various sports including cricket, football, basketball, and track events.",
            "GUEST HOUSE": "The Guest House provides accommodation for visiting faculty, guests, and parents with well-furnished rooms and modern amenities.",
            "GM INSTITUTE OF PHARMACEUTICAL SCIENCES AND RESEARCH": "This institute offers pharmacy programs with modern laboratories, research facilities, and experienced faculty members.",
            "GM HALAMMA PU COLLEGE": "The pre-university college offers science, commerce, and arts streams for intermediate education with qualified teaching staff.",
            "GMS ACADEMY DEGREE COLLEGE(BCA,BCom)": "The degree college offers undergraduate programs in Computer Applications and Commerce with modern teaching methodologies.",
            "MAIN ENTERANCE": "The main entrance to the campus with security checkpost and visitor management system.",
            "GANESHA TEMPLE": "A serene temple dedicated to Lord Ganesha, providing a spiritual space for students and staff.",
            "GM BAKERY": "The campus bakery offers fresh baked goods, snacks, and beverages for students and staff.",
            "CAR PARKING AREA": "Spacious parking area for students, staff, and visitors with capacity for 500 vehicles.",
            "BUSTAND AREA": "Designated area for buses with shelters and seating arrangements for students.",
            "LAWN": "Beautifully maintained green space with seating areas for students to relax and study.",
            "CIRCLE": "Central circular area with decorative elements, often used for gatherings and events.",
            "FLAG AREA": "The ceremonial flag area where important events and flag hoisting ceremonies take place."
        };
        
        // Building floors data - YOU CAN REPLACE THESE WITH YOUR OWN FILE NAMES
        const buildingFloors = {
            "ENGINEERING BLOCK": [
                { name: "Basement Floor", image: "engineering_basement.jpg", description: "Contains workshops, storage, and mechanical labs", onClick: () => showEngFloorModal('basement') },
                { name: "Ground Floor", image: "engineering_ground.jpg", description: "Contains workshops, laboratories, and main auditorium", onClick: () => showEngFloorModal('ground') },
                { name: "First Floor", image: "engineering_first.jpg", description: "Computer Science department classrooms and labs", onClick: () => showEngFloorModal('first') },
                { name: "Second Floor", image: "engineering_second.jpg", description: "Electronics and Mechanical departments", onClick: () => showEngFloorModal('second') },
                { name: "Third Floor", image: "engineering_third.jpg", description: "Faculty offices and conference rooms", onClick: () => showEngFloorModal('third') }
                
            ],
            "CENTRAL LIBRARY": [
                { name: "Ground Floor", image: "library_ground.jpg", description: "Circulation desk, periodicals, and reference section" },
                { name: "First Floor", image: "library_first.jpg", description: "Science and technology books collection" },
                { name: "Second Floor", image: "library_second.jpg", description: "Arts, commerce, and literature section" },
                { name: "Third Floor", image: "library_third.jpg", description: "Digital library and group study rooms" }
                
            ],
            "ADMIN BLOCK": [
                { name: "Ground Floor", image: "admin_ground.jpg", description: "Reception, accounts office, and administrative staff" },
                { name: "First Floor", image: "admin_first.jpg", description: "Registrar office, examination cell" },
                { name: "Second Floor", image: "admin_second.jpg", description: "Principal office, conference hall, and meeting rooms" }
                
            ],
            "LADIES HOSTEL": [
                { name: "Ground Floor", image: "hostel_ground.jpg", description: "Common room, dining hall, and warden office" },
                { name: "First Floor", image: "hostel_first.jpg", description: "Student rooms and shared facilities" },
                { name: "Second Floor", image: "hostel_second.jpg", description: "Student rooms and study area" }
                
            ],
            "GENTS HOSTEL": [
                { name: "Ground Floor", image: "hostel_ground.jpg", description: "Common room, dining hall, and warden office" },
                { name: "First Floor", image: "hostel_first.jpg", description: "Student rooms and shared facilities" },
                { name: "Second Floor", image: "hostel_second.jpg", description: "Student rooms and study area" }
               
            ]
        };
        
        // Define node types for styling
        const nodeTypes = {
            "CENTRAL LIBRARY": "academic",
            "ENGINEERING BLOCK": "academic",
            "GM INSTITUTE OF PHARMACEUTICAL SCIENCES AND RESEARCH": "academic",
            "GM HALAMMA PU COLLEGE": "academic",
            "GMS ACADEMY DEGREE COLLEGE(BCA,BCom)": "academic",
            "CANTEEN": "service",
            "GM BAKERY": "service",
            "LADIES HOSTEL": "residence",
            "GENTS HOSTEL": "residence",
            "PLAYGROUND": "sports",
            "ADMIN BLOCK": "admin",
            "MAIN ENTERANCE": "entrance",
            "CAR PARKING AREA": "service",
            "GUEST HOUSE": "service",
            "GANESHA TEMPLE": "service",
            "LAWN": "service",
            "CIRCLE": "service",
            "BUSTAND AREA": "service",
            "FLAG AREA": "service"
        };
        
        // Basement floor data (from the provided basement floor code)
        const basementNodes = [
           "ADE/MS LAB C-B109","COMPUTER LAB C-B10","CR-03 C-B11","ELECTRICAL DB ROOM C-B12","WEST STAIRS",
        "STAFF ROOM-02(BASIC SCIENCES B-15)","RESEARCH CENTRE B-16","CR-04 C-B17","CR-05 C-B18","CR-06 C-B19",
        "CAD LAB C-B08","DESIGN LAB & MACHINE SHOP C-B20","NORTH STAIRS","STAFFROOM(ED) C-B07","XEROX C-B01A",
        "COOPERATIVE SOCIETY C-B06","STORE C-B01","CR-01","ECE LAB C-B02","FM &ML LAB C-B03"
        ];
        
        // Connections between nodes
        const basementEdges = [
             ["ADE/MS LAB C-B109", "COMPUTER LAB C-B10"],
        ["COMPUTER LAB C-B10", "CR-03 C-B11"],
        ["CR-03 C-B11", "ELECTRICAL DB ROOM C-B12"],
        ["ELECTRICAL DB ROOM C-B12", "WEST STAIRS"],
        ["WEST STAIRS", "STAFF ROOM-02(BASIC SCIENCES B-15)"],
        ["STAFF ROOM-02(BASIC SCIENCES B-15)", "RESEARCH CENTRE B-16"],
        ["RESEARCH CENTRE B-16", "CR-04 C-B17"],
        ["CR-04 C-B17", "CR-05 C-B18"],
        ["CR-05 C-B18", "CR-06 C-B19"],
        ["CR-06 C-B19", "CAD LAB C-B08"],
        
        ["NORTH STAIRS", "STAFFROOM(ED) C-B07"],
        ["STAFFROOM(ED) C-B07", "CAD LAB C-B08"],
        ["CAD LAB C-B08", "DESIGN LAB & MACHINE SHOP C-B20"],
        ["STAFFROOM(ED) C-B07", "COOPERATIVE SOCIETY C-B06"],
        ["XEROX C-B01A", "COOPERATIVE SOCIETY C-B06"],
        ["COOPERATIVE SOCIETY C-B06", "CR-01"],
        ["STORE C-B01", "CR-01"],
        ["CR-01", "ECE LAB C-B02"],
        ["ECE LAB C-B02", "FM &ML LAB C-B03"],
        ];
        
        // Node positions
        const basementNodePositions = {
        "ADE/MS LAB C-B109": { x: 400, y: 650 },
        "COMPUTER LAB C-B10": { x: 200, y: 650 },
        "CR-03 C-B11": { x: 200, y: 600 },
        "ELECTRICAL DB ROOM C-B12": { x: 200, y: 550 },
        "WEST STAIRS": { x: 200, y: 500 },
        "STAFF ROOM-02(BASIC SCIENCES B-15)": { x: 200, y: 450 },
        "RESEARCH CENTRE B-16": { x: 200, y: 400 },
        "CR-04 C-B17": { x: 200, y: 350 },
        "CR-05 C-B18": { x: 200, y: 300 },
        "CR-06 C-B19": { x: 200, y: 250 },
        "CAD LAB C-B08": { x: 300, y: 250 },
        "DESIGN LAB & MACHINE SHOP C-B20": { x: 300, y: 150 },
        "NORTH STAIRS": { x: 450, y: 150 },
        "STAFFROOM(ED) C-B07": { x: 450, y: 250 },
        "XEROX C-B01A": { x: 600, y: 150 },
        "COOPERATIVE SOCIETY C-B06": { x: 600, y: 250 },
        "STORE C-B01": { x: 750, y: 150 },
        "CR-01": { x: 750, y: 250 },
        "ECE LAB C-B02": { x: 850, y: 150 },
        "FM &ML LAB C-B03": { x: 850, y: 300 }
        };
        
        // Engineering Block Floor Data
        // Ground floor nodes (match positions/edges exactly)
        const groundFloorNodes = [
            "Main Entrance", "North Entrance", "South Entrance", "East Entrance",
            "Senior Dean C-024", "Principal C-021", "Management Representative C-022", "Board Room C-023",
            "Office", "Office C-020", "Staff Room C-013", "Chemistry Lab C-001", "Physics Lab C-004",
            "Department of Mathematics", "Prof & Head dept of ED", "Seminar Hall C-017 ED",
            "Training & Placement Cell", "CASP C-019", "Data Center C-031", "Windows Lab C-032",
            "Gem Ventures SW-Development C-030", "Research Lab C-033", "Class Room 13 C-012",
            "Class Room 12 C-011", "Class Room 11 C-010", "Class Room 10 C-009", "Class Room 9 C-005",
            "Staff room Physics C-005", "Class Room 7 C-002", "Class Room 8 C-003", "Class Room 15 C-026",
            "Class Room 14 C-025", "Class Room 16 C-027", "Class Room 17 C-028", "Class Room 18 C-029",
            "Gents Toilet", "Ladies Toilet", "Drinking Water", "Passage", "Corridor 2.5m",
            "Corridor 2.95m", "Stage", "Lift", "Professor and Head Department of Robotics C-014",
            "Wash room (girls) C-015", "Wash room (Boys) C-016"
        ];

        // First floor nodes (match positions/edges exactly)
        const firstFloorNodes = [
            "NORTH STAIRS", "STAFF-ROOM 8/ CR-123", "C-122", "C-121", "CAD LAB/C-118",
            "LADIES TOILET 1", "GENTS TOILET 1", "C-117", "C-116", "C-115", "C-114",
            "STAFF ROOM-7 /C-113", "GENTS TOILET-2", "WEST STAIRS", "LADIES TOILET-2", "C-109",
            "CS STAFF ROOM-6/C-108", "C-107", "C-106", "C-105", "ISE-HOD/C-104", "STAFF ROOM-5/C-103",
            "NETWORK LAB/C-102", "PROJECT LAB/C-101", "SOUTH STAIRS", "COMPUTER CENTER/C-140", "UPS",
            "STAFF-ROOM-10/C-139", "SEMINAR HALL/C-138", "ALGORITHMS & OS LAB/C-134",
            "ANALOG & DIGITAL ELECTRONICS LAB/C-135", "MICROPROCESSOR & MICROCONTROLLER LAB/C-136",
            "CS STAFF ROOM-7/C-133", "C-132", "CS HOD ROOM", "EAST STAIRS", "C-130", "C-129",
            "C-128", "CIVIL SEMINAR HALL", "CIVIL HOD ROOM", "C-127", "ENVIRONMENTAL LAB/C-126"
        ];

        // Second floor nodes (match positions/edges exactly)
        const secondFloorNodes = [
            "NORTH STAIRS", "AUDITORIUM/C-222", "SR-12/C-221", "C-220", "C-217", "WR-218", "WR-219",
            "C-216", "C-215", "C-214", "C-213", "C-212", "WR-210", "West Stairs", "WR-209",
            "C-208", "C-207/ADC LAB", "SR-11/EEE", "CIRCUIT LAB/205", "C-204", "EEE HOD/C-203",
            "COMMUNICATION LAB/C-202", "C-245", "SOUTH STAIRS", "C-244", "Project-LAB and R&D LAB/C-243",
            "SR-18/C-242", "C-241", "C-240", "C-239", "COMPUTER LAB-02", "COMPUTER LAB-01",
            "SR-16/C-238", "SR-15/C-234", "E&C SR-14/S-233", "C-232", "E&C HOD/C-231", "SR-13/AIML",
            "East Stairs", "C-229", "DataScience Lab/C-228", "Neutral NetworkLAB/C-227",
            "DeepLearning-LAB/C-226", "STORE ROOM-05", "C-224", "AIML-HOD/C-223"
        ];

        // Third floor data
        const thirdFloorNodes = [
                  "RESEARCH LAB","BT LAB+BIOPROCESS","WIDE CORRIDOR","CR-06","CR-05","STAFF ROOM","CR-26","LAB ROOM-07","CR-07","BT LAB-01",
        "CR-08","CR-09","CR-10","CR-11","CR-12","CR-13-48X","BT-CR-02","BT-CR-01","OUT OPEN","CAFETERIA",
        "MBA AUDITORIUM","HOD-BT","BT-CR-03","BT-CR-04","BIOINFOMATICS","NCC UNIT","NSS/NCC","MBA DIRECTOR","STAFF ROOMS","COMPUTER LAB",
        "LADIES TOILET","BOARD ROOM","EAST STAIRS","NORTH STAIRS","WEST STAIRS","SOUTH STAIRS"
        
        ];

        // Ground floor connections
        const groundFloorEdges = [
             ["Main Entrance", "South Entrance"],
            ["Corridor 2.5m", "Windows Lab C-032"],
            ["South Entrance", "Corridor 2.5m"],
            ["Windows Lab C-032", "Research Lab C-033"],
            ["Class Room 7 C-002", "Physics Lab C-004"],
            ["Class Room 7 C-002", "Department of Mathematics"],
            ["Department of Mathematics", "Chemistry Lab C-001"],
            ["Physics Lab C-004", "Staff room Physics C-005"],
            ["Staff room Physics C-005", "Class Room 9 C-005"],
            ["Drinking Water", "Gents Toilet"],
            ["Ladies Toilet", "Gents Toilet"],
            ["Gents Toilet", "Class Room 10 C-009"],
            ["Class Room 10 C-009", "Class Room 11 C-010"],
            ["Class Room 11 C-010", "Class Room 12 C-011"],
            ["Class Room 12 C-011", "Class Room 13 C-012"],
            ["Class Room 13 C-012", "Seminar Hall C-017 ED"],
            ["Class Room 13 C-012", "Staff Room C-013"],
            ["Professor and Head Department of Robotics C-014", "Staff Room C-013"],
            ["Wash room (girls) C-015", "Professor and Head Department of Robotics C-014"],
            ["Wash room (Boys) C-016", "Wash room (girls) C-015"],
            ["Seminar Hall C-017 ED", "Prof & Head dept of ED"],
           
           
            ["Training & Placement Cell", "Prof & Head dept of ED"],
            ["Stage", "Corridor 2.5m"],
            
            ["Stage", "Corridor 2.95m"],
            ["CASP C-019", "Training & Placement Cell"],
            ["Corridor 2.95m", "North Entrance"],
            ["Class Room 7 C-002", "Class Room 8 C-003"],
            ["Class Room 7 C-002", "Research Lab C-033"],
            ["Class Room 8 C-003", "Physics Lab C-004"],
            ["Class Room 9 C-005", "Ladies Toilet"],
            ["Corridor 2.5m", "Data Center C-031"],
            ["Data Center C-031", "Gem Ventures SW-Development C-030"],
            ["Gem Ventures SW-Development C-030", "Class Room 17 C-028"],
            ["Class Room 17 C-028", "Class Room 16 C-027"],
            ["Class Room 16 C-027", "Class Room 15 C-026"],
            ["Class Room 14 C-025", "Class Room 15 C-026"],
            ["Lift", "Class Room 14 C-025"],
            ["Class Room 17 C-028", "Class Room 18 C-029"],
            ["Lift", "East Entrance"],
            ["East Entrance", "Senior Dean C-024"],
            ["Senior Dean C-024", "Board Room C-023"],
            ["Board Room C-023", "Principal C-021"],
            ["Principal C-021", "Office C-020"],
            ["Management Representative C-022", "Principal C-021"],
            ["Office C-020", "Office"],
            ["CASP C-019", "Board Room C-023"]
        ];

        // First floor connections
        const firstFloorEdges = [
            ["NORTH STAIRS", "STAFF-ROOM 8/ CR-123"],
            ["STAFF-ROOM 8/ CR-123", "C-122"],
            ["STAFF-ROOM 8/ CR-123", "CIVIL HOD ROOM"],
            ["C-122", "C-121"],
            ["C-121", "CAD LAB/C-118"],
            ["CAD LAB/C-118", "LADIES TOILET 1"],
            ["CAD LAB/C-118", "C-117"],
            ["LADIES TOILET 1", "GENTS TOILET 1"],
            ["C-117", "C-116"],
            ["C-116", "C-115"],
            ["C-115", "C-114"],
            ["C-114", "STAFF ROOM-7 /C-113"],
            ["STAFF ROOM-7 /C-113", "GENTS TOILET-2"],
            ["GENTS TOILET-2", "WEST STAIRS"],
            ["WEST STAIRS", "LADIES TOILET-2"],
            ["LADIES TOILET-2", "C-109"],
            ["C-109", "CS STAFF ROOM-6/C-108"],
            ["CS STAFF ROOM-6/C-108", "C-107"],
            ["C-107", "C-106"],
            ["C-106", "C-105"],
            ["C-105", "ISE-HOD/C-104"],
            ["ISE-HOD/C-104", "STAFF ROOM-5/C-103"],
            ["STAFF ROOM-5/C-103", "NETWORK LAB/C-102"],
            ["NETWORK LAB/C-102", "PROJECT LAB/C-101"],
            ["STAFF-ROOM-10/C-139", "SOUTH STAIRS"],
            ["COMPUTER CENTER/C-140", "UPS"],
            ["COMPUTER CENTER/C-140","C-105"],
            ["COMPUTER CENTER/C-140", "STAFF-ROOM-10/C-139"],
            ["STAFF-ROOM-10/C-139", "SEMINAR HALL/C-138"],
            ["SEMINAR HALL/C-138", "ALGORITHMS & OS LAB/C-134"],
            ["ALGORITHMS & OS LAB/C-134", "ANALOG & DIGITAL ELECTRONICS LAB/C-135"],
            ["ANALOG & DIGITAL ELECTRONICS LAB/C-135", "MICROPROCESSOR & MICROCONTROLLER LAB/C-136"],
            ["MICROPROCESSOR & MICROCONTROLLER LAB/C-136", "CS STAFF ROOM-7/C-133"],
            ["CS STAFF ROOM-7/C-133", "C-132"],
            ["C-132", "CS HOD ROOM"],
            ["CS HOD ROOM", "EAST STAIRS"],
            ["EAST STAIRS", "C-130"],
            ["EAST STAIRS","CS HOD ROOM"],
            ["CS HOD ROOM","C-132"],
            ["C-130", "C-129"],
            ["C-129", "C-128"],
            ["C-128", "CIVIL SEMINAR HALL"],
            ["CIVIL SEMINAR HALL", "CIVIL HOD ROOM"],
            ["C-127", "C-128"],
            ["C-127","ENVIRONMENTAL LAB/C-126"]
        ];

        // Second floor connections
        const secondFloorEdges = [
           ["NORTH STAIRS", "AUDITORIUM/C-222"],
            ["AUDITORIUM/C-222", "SR-12/C-221"],
            ["SR-12/C-221", "C-220"],
            ["C-217", "C-216"],
            ["C-217", "WR-218"],
            ["WR-218", "WR-219"],
            ["C-220", "C-216"],
            ["C-216", "C-215"],
            ["C-215", "C-214"],
            ["C-214", "C-213"],
            ["C-213", "C-212"],
            ["C-212", "WR-210"],
            ["WR-210", "West Stairs"],
            ["West Stairs", "WR-209"],
            ["WR-209", "C-208"],
            ["C-208", "C-207/ADC LAB"],
            ["C-207/ADC LAB", "SR-11/EEE"],
            ["SR-11/EEE", "CIRCUIT LAB/205"],
            ["CIRCUIT LAB/205", "C-204"],
            ["C-204", "EEE HOD/C-203"],
            ["EEE HOD/C-203", "COMMUNICATION LAB/C-202"],
            ["C-204", "C-245"],
            ["C-245", "C-244"],
            ["C-244", "Project-LAB and R&D LAB/C-243"],
            ["Project-LAB and R&D LAB/C-243", "SR-18/C-242"],
            ["Project-LAB and R&D LAB/C-243", "SOUTH STAIRS"],
            ["SR-18/C-242", "C-241"],
            ["C-241", "C-240"],
            ["C-240", "COMPUTER LAB-01"],
            ["COMPUTER LAB-01", "C-239"],
            ["COMPUTER LAB-02", "SR-16/C-238"],
            ["C-239", "COMPUTER LAB-02"],
            ["C-239", "COMPUTER LAB-01"],
            ["COMPUTER LAB-01", "SR-15/C-234"],
            ["SR-15/C-234", "E&C SR-14/S-233"],
            ["E&C SR-14/S-233", "C-232"],
            ["C-232", "E&C HOD/C-231"],
            ["E&C HOD/C-231", "SR-13/AIML"],
            ["SR-13/AIML", "East Stairs"],
            ["East Stairs", "C-229"],
            ["C-229", "DataScience Lab/C-228"],
            ["DataScience Lab/C-228", "Neutral NetworkLAB/C-227"],
            ["Neutral NetworkLAB/C-227", "DeepLearning-LAB/C-226"],
            ["DeepLearning-LAB/C-226", "STORE ROOM-05"],
            ["STORE ROOM-05", "C-224"],
            ["C-224", "AIML-HOD/C-223"],
            // Direct connection from STORE ROOM-05 to DataScience Lab
            ["STORE ROOM-05", "DataScience Lab/C-228"]
        ];

        // Third floor connections
        const thirdFloorEdges = [
            ["RESEARCH LAB", "BT LAB+BIOPROCESS"],
        ["RESEARCH LAB","WIDE CORRIDOR"],
        ["WIDE CORRIDOR", "CR-06"],
        ["CR-06", "CR-05"],
        ["CR-06", "CR-05"],
        ["RESEARCH LAB", "BT LAB-01"],
        ["BT LAB-01", "CR-26"],
        ["CR-26", "LAB ROOM-07"],
        ["BT LAB-01", "CR-07"],
        ["CR-07", "CR-08"],
        ["CR-08", "CR-09"],
        ["CR-09","CR-10"],
        ["CR-10", "CR-11"],
        ["CR-11", "CR-12"],
        ["CR-12","BOARD ROOM"],
        ["BOARD ROOM","LADIES TOILET"],
        ["CR-12", "CR-13-48X"],
        ["CR-05", "BT-CR-02"],
        ["BT-CR-02","BT-CR-01"],
        ["BT-CR-02","HOD-BT"],
        ["CR-13-48X", "OUT OPEN"],
        ["OUT OPEN", "CAFETERIA"],
        ["CAFETERIA", "MBA AUDITORIUM"],
        ["MBA AUDITORIUM", "STAFF ROOMS"],
        ["HOD-BT","BT-CR-03"],
        ["BT-CR-03","BT-CR-04"],
        ["BT-CR-04","BIOINFORMATICS"],
        ["BT-CR-01","NSS/NCC"],
        
        ["NSS/NCC","EAST STAIRS"],
        ["EAST STAIRS","MBA DIRECTOR"],
        ["MBA DIRECTOR","STAFF ROOMS"],
        ["STAFF ROOMS","COMPUTER LAB"],
        ["CR-09","WEST STAIRS"],
        ["WEST STAIRS","CR-10"]
        ];

        // Ground floor positions
        const groundFloorNodePositions = {
           "Main Entrance": { x: 500, y: 900 },
            "North Entrance": { x: 500, y: 50 },
            "South Entrance": { x: 500, y: 850 },
            "East Entrance": { x: 900, y: 400 },
            "Senior Dean C-024": { x: 900, y: 300 },
            "Principal C-021": { x: 900, y: 150 },
            "Management Representative C-022": {x:900, y:200},
            "Board Room C-023": { x: 900, y: 250 },
            "Office": { x: 800, y: 100 },
            "Office C-020": { x: 900, y: 100 },
            "Staff Room C-013": { x: 200, y: 180 },
            "Chemistry Lab C-001": { x: 200, y: 900 },
            "Physics Lab C-004": { x: 200, y: 690 },
            "Department of Mathematics": { x: 200, y: 850 },
            "Prof & Head dept of ED": { x: 400, y: 250 },
            "Seminar Hall C-017 ED": { x: 290, y: 250 },
            "Training & Placement Cell": { x: 600, y: 250 },
            "CASP C-019":{x: 700, y:250},
            "Data Center C-031": { x: 600, y: 800 },
            "Windows Lab C-032": { x: 400, y: 800 },
            "Gem Ventures SW-Development C-030": { x: 750, y: 800 },
            "Research Lab C-033": { x: 300, y: 800 },
            "Class Room 13 C-012": { x: 200, y: 250 },
            "Class Room 12 C-011": { x: 200, y: 300 },
            "Class Room 11 C-010": { x: 200, y: 350 },
            "Class Room 10 C-009": { x: 200, y: 400 },
            "Class Room 9 C-005": { x: 200, y: 590 },
            "Gents Toilet": { x: 200, y: 500 },
            "Ladies Toilet": { x: 200, y: 550 },
            "Drinking Water":{x: 200, y: 450},
            "Staff room Physics C-005": { x: 200, y: 640 },
            "Class Room 7 C-002": { x: 200, y: 800 },
            "Class Room 8 C-003": { x: 200, y: 740 },
            "Class Room 15 C-026": { x: 900, y: 650 },
            "Class Room 14 C-025": { x: 900, y: 600 },
            "Class Room 16 C-027": { x: 900, y: 730 },
            "Class Room 17 C-028": { x: 900, y: 800 },
            "Class Room 18 C-029": { x: 900, y: 850 },
            "Passage": { x: 150, y: 560 },
            "Corridor 2.5m": { x: 500, y: 800 },
            "Corridor 2.95m": { x: 500, y: 200 },
            "Stage": { x: 500, y: 300 },
            "Lift": { x: 900, y: 450 },
            "Professor and Head Department of Robotics C-014": { x: 200, y: 140},
            "Wash room (girls) C-015": { x: 200, y: 100},
            "Wash room (Boys) C-016": {x: 350, y:100}
        
        };

        // First floor positions
        const firstFloorNodePositions = {
            "NORTH STAIRS": { x: 500, y: 50 },
            "STAFF-ROOM 8/ CR-123": { x: 500, y: 150 },
            "C-122": { x: 400, y: 150 },
            "C-121": { x: 300, y: 150 },
            "CAD LAB/C-118": { x: 250, y: 150 },
            "LADIES TOILET 1": { x: 250, y: 60 },
            "GENTS TOILET 1": { x: 300, y: 60 },
            "C-117": { x: 250, y: 200 },
            "C-116": { x: 250, y: 250 },
            "C-115": { x: 250, y: 300 },
            "C-114": { x: 250, y: 350 },
            "STAFF ROOM-7 /C-113": { x: 250, y: 400 },
            "GENTS TOILET-2": { x: 250, y: 450 },
            "WEST STAIRS": { x: 180, y: 500 },
            "LADIES TOILET-2": { x: 250, y: 530 },
            "C-109": { x: 250, y: 590 },
            "CS STAFF ROOM-6/C-108": { x: 250, y: 630 },
            "C-107": { x: 250, y: 680 },
            "C-106": { x: 250, y: 750 },
            "C-105": { x: 250, y: 800 },
            "ISE-HOD/C-104": { x: 250, y: 850 },
            "STAFF ROOM-5/C-103": { x: 250, y: 890 },
            "NETWORK LAB/C-102": { x: 250, y: 930 },
            "PROJECT LAB/C-101": { x: 250, y: 970 },
            "SOUTH STAIRS": { x: 500, y: 850 },
            "COMPUTER CENTER/C-140": { x: 350, y: 800 },
            "UPS": { x: 420, y: 800 },
            "STAFF-ROOM-10/C-139": { x: 500, y: 800 },
            "SEMINAR HALL/C-138": { x: 600, y: 800 },
            "ALGORITHMS & OS LAB/C-134": { x: 700, y: 800 },
            "ANALOG & DIGITAL ELECTRONICS LAB/C-135": { x: 700, y: 850 },
            "MICROPROCESSOR & MICROCONTROLLER LAB/C-136": { x: 700, y: 950 },
            "CS STAFF ROOM-7/C-133": { x: 700, y: 700 },
            "C-132": { x: 700, y: 625 },
            "CS HOD ROOM": { x: 700, y: 550 },
            "EAST STAIRS": { x: 760, y: 470 },
            "C-130": { x: 700, y: 370 },
            "C-129": { x: 700, y: 250 },
            "ENVIRONMENTAL LAB/C-126": { x: 650, y: 50 },
            "C-127": { x: 700, y: 50 },
            "C-128": { x: 700, y: 150 },
            "CIVIL SEMINAR HALL": { x: 650, y: 150 },
            "CIVIL HOD ROOM": { x: 570, y: 150 }
        };

        // Second floor positions
        const secondFloorNodePositions = {
             "NORTH STAIRS": { x: 500, y: 50 },
            "AUDITORIUM/C-222": { x: 500, y: 150 },
            "SR-12/C-221": { x: 400, y: 150 },
            "C-220": { x: 320, y: 150 },
            "C-217": { x: 250, y: 100 },
            "WR-218": { x: 250, y: 60 },
            "WR-219": { x: 300, y: 60 },
            "C-216": { x: 250, y: 125 },
            "C-215": { x: 250, y: 150 },
            "C-214": { x: 250, y: 250 },
            "C-213": { x: 250, y: 300 },
            "C-212": { x: 250, y: 350 },
            "WR-210": { x: 250, y: 450 },
            "West Stairs": { x: 250, y: 500 },
            "WR-209": { x: 250, y: 550 },
            "C-208": { x: 250, y: 600 },
            "C-207/ADC LAB": { x: 250, y: 650 },
            "SR-11/EEE": { x: 250, y: 700 },
            "CIRCUIT LAB/205": { x: 250, y: 750 },
            "C-204": { x: 250, y: 800 },
            "EEE HOD/C-203": { x: 250, y: 870 },
            "COMMUNICATION LAB/C-202": { x: 250, y: 950 },
            "C-245": { x: 320, y: 800 },
            "SOUTH STAIRS": { x: 500, y: 850 },
            "C-244": { x: 380, y: 800 },
            "Project-LAB and R&D LAB/C-243": { x: 500, y: 800 },
            "SR-18/C-242": { x: 550, y: 800 },
            "C-241": { x: 580, y: 800 },
            "C-240": { x: 640, y: 800 },
            "C-239": { x: 700, y: 850 },
            "COMPUTER LAB-02": { x: 700, y: 950 },
            "COMPUTER LAB-01": { x: 700, y: 800 },
            "SR-16/C-238": { x: 650, y: 950 },
            "SR-15/C-234": { x: 700, y: 750 },
            "E&C SR-14/S-233": { x: 700, y: 710 },
            "C-232": { x: 700, y: 660 },
            "E&C HOD/C-231": { x: 700, y: 610 },
            "SR-13/AIML": { x: 700, y: 550 },
            "East Stairs": { x: 700, y: 500 },
            "C-229": { x: 700, y: 400 },
            "DataScience Lab/C-228": { x: 700, y: 300 },
            "Neutral NetworkLAB/C-227": { x: 700, y: 100 },
            "DeepLearning-LAB/C-226": { x: 700, y: 50 },
            "STORE ROOM-05": { x: 700, y: 150 },
            "C-224": { x: 620, y: 150 },
            "AIML-HOD/C-223": { x: 560, y: 150 }
        };

        // Third floor positions
        const thirdFloorNodePositions = {
             "RESEARCH LAB": { x: 400, y: 650 },
         "BT LAB+BIOPROCESS": { x:300 , y: 650 },
         "CR-06": { x:620, y: 650 },
         "WIDE CORRIDOR":{x: 500, y: 700},
         "CR-06": { x: 620, y: 650 },
         "CR-05": { x: 700, y: 650 },
         "BT LAB-01": { x: 200, y: 650 },
         "CR-26": { x: 200, y: 700 },
         "LAB ROOM-07": { x: 200, y: 750 },
         "CR-07": { x: 200, y: 600 },
         "CR-08": { x: 200, y: 500 },
         "CR-09": { x: 200, y: 440},
         "CR-10": { x: 200, y: 400 },
         "CR-11": { x: 200, y: 350 },
         "CR-12": { x: 200, y: 250 },
         "BOARD ROOM": {x:200,y:200},
         "LADIES TOILET": {x:200,y:150},
         "CR-13-48X": { x: 300, y: 250 },
         "BT-CR-02": { x: 900, y: 650 },
         "BT-CR-01": {x:900, y: 600},
         "OUT OPEN": { x: 400, y: 250 },
         "CAFETERIA": { x: 500, y: 150 },
         "MBA AUDITORIUM": { x: 600, y: 250 },
         "STAFF ROOMS": { x:200, y:700},
         "HOD-BT": { x: 900, y: 750 },
         "BT-CR-03": { x: 900, y: 800 },
         "BT-CR-04": { x: 900, y: 850 },
         "BIOINFORMATICS": { x: 900, y: 900 },
         "NSS/NCC" : { x: 900, y: 500 },
         "MBA DIRECTOR": { x: 900, y: 350 },
         "STAFF ROOMS": { x: 900, y: 250 },
         "COMPUTER LAB": {x:900, y:150},
         "EAST STAIRS":{x:900,y:450},
         "WEST STAIRS":{x:200,y:420}
        };

        // Floor data structure for Engineering Block
        const engFloorData = {
            basement: { nodes: basementNodes, edges: basementEdges, positions: basementNodePositions, name: "Basement Floor" },
            ground:   { nodes: groundFloorNodes, edges: groundFloorEdges, positions: groundFloorNodePositions, name: "Ground Floor" },
            first:    { nodes: firstFloorNodes, edges: firstFloorEdges, positions: firstFloorNodePositions,   name: "First Floor" },
            second:   { nodes: secondFloorNodes, edges: secondFloorEdges, positions: secondFloorNodePositions, name: "Second Floor" },
            third:    { nodes: thirdFloorNodes, edges: thirdFloorEdges, positions: thirdFloorNodePositions,   name: "Third Floor" }
        };
        
        const floorConfig = {
            zoomLevel: 0.8,
            gridSize: 50
        };
        
        const basementConfig = {
            zoomLevel: 0.8
        };
        
        let currentPath = [];
        let currentPosition = null;
        let destination = null;
        let avatar = null;
        let guidanceInterval = null;
        let currentStep = 0;
        let recognition = null;
        let isListening = false;
        let speechSynthesis = window.speechSynthesis;
        let isSpeaking = false;
        
        // Helper: identify artificial junction nodes used along the main road
        const isJunction = (name) => typeof name === 'string' && name.startsWith('J-');
        
        // Basement floor variables
        let basementCurrentPath = [];
        let basementCurrentPosition = null;
        let basementDestination = null;
        let basementAvatar = null;
        let basementGuidanceInterval = null;
        let basementCurrentStep = 0;
        
        // Engineering floor modal state
        let engFloorKey = null;
        let engZoom = 0.8;
        let engPath = [];
        let engCurrentPosition = null;
        let engDestination = null;
        let engAvatar = null;
        let engGuidanceInterval = null;
        let engStep = 0;
        
        // Define building-to-building shortcuts (for weighted routing)
        const buildingShortcuts = new Set([
            "ENGINEERING BLOCK|ADMIN BLOCK","ADMIN BLOCK|ENGINEERING BLOCK",
            "ENGINEERING BLOCK|GANESHA TEMPLE","GANESHA TEMPLE|ENGINEERING BLOCK",
            "GANESHA TEMPLE|FLAG AREA","FLAG AREA|GANESHA TEMPLE",
            "ENGINEERING BLOCK|LAWN","LAWN|ENGINEERING BLOCK",
            "LAWN|GM BAKERY","GM BAKERY|LAWN",
            "PLAYGROUND|GUEST HOUSE","GUEST HOUSE|PLAYGROUND",
            "LADIES HOSTEL|CAR PARKING AREA","CAR PARKING AREA|LADIES HOSTEL"
        ]);

        // Create a graph from edges for pathfinding
        function createGraph() {
            const graph = {};
            
            // Add nodes
            nodes.forEach(node => {
                graph[node] = [];
            });
            
            // Add edges
            edges.forEach(edge => {
                const [from, to] = edge;
                if (graph[from] && graph[to]) {
                    graph[from].push(to);
                    graph[to].push(from); // Make it bidirectional
                } else {
                    console.error(`Invalid edge: ${from} -> ${to}`);
                }
            });
            
            return graph;
        }
        
        // Weighted shortest path (Dijkstra). Prefers main-road junctions/spokes over building-to-building shortcuts
        function getEdgeWeight(a, b, destination) {
            const isShortcut = buildingShortcuts.has(`${a}|${b}`);
            if (!isShortcut) return 1; // junction chain and building-to-junction spokes
            // If the shortcut leads directly to the destination (either direction), keep it cheap
            if (b === destination || a === destination) return 1;
            return 3; // otherwise discourage using building-to-building as transit
        }

        function findShortestPath(graph, start, end) {
            if (start === end) return [start];
            const dist = {}; const prev = {}; const visited = new Set();
            nodes.forEach(n => { dist[n] = Infinity; prev[n] = null; });
            dist[start] = 0;
            
            while (visited.size < nodes.length) {
                // pick unvisited node with smallest dist
                let u = null; let best = Infinity;
                for (const n of nodes) {
                    if (!visited.has(n) && dist[n] < best) { best = dist[n]; u = n; }
                }
                if (u === null) break; // unreachable nodes left
                if (u === end) break;
                visited.add(u);
                const neighbors = graph[u] || [];
                neighbors.forEach(v => {
                    if (visited.has(v)) return;
                    const w = getEdgeWeight(u, v, end);
                    const alt = dist[u] + w;
                    if (alt < dist[v]) { dist[v] = alt; prev[v] = u; }
                });
            }
            if (dist[end] === Infinity) return null;
            const path = []; let cur = end;
            while (cur) { path.unshift(cur); cur = prev[cur]; }
            return path;
        }
        
        // Generate 90-degree path between two points
        function generatePath(start, end) {
            const pathPoints = [start];
            
            // First move horizontally, then vertically (90-degree path)
            pathPoints.push({x: end.x, y: start.y});
            pathPoints.push(end);
            
            return pathPoints;
        }
        
        // Calculate the complete path with 90-degree turns
        function calculateCompletePath(path) {
            const completePath = [];
            
            for (let i = 0; i < path.length - 1; i++) {
                const startNode = path[i];
                const endNode = path[i + 1];
                
                const startPos = nodePositions[startNode];
                const endPos = nodePositions[endNode];
                
                if (startPos && endPos) {
                    const segmentPath = generatePath(startPos, endPos);
                    
                    // Add to complete path (skip the first point to avoid duplicates)
                    if (i === 0) {
                        completePath.push(segmentPath[0]);
                    }
                    completePath.push(segmentPath[1]);
                    completePath.push(segmentPath[2]);
                }
            }
            
            return completePath;
        }
        
        // Voice recognition functions
        function initVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                showVoiceNotification("Voice recognition is not supported in your browser. Please use Chrome, Edge, or Safari.", "error");
                return false;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US';
            
            recognition.onstart = function() {
                isListening = true;
                document.getElementById('voiceBtn').classList.add('listening');
                document.getElementById('voiceStatus').textContent = "Listening...";
                showVoiceNotification("Listening... Please speak your current location and destination.", "info");
            };
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript.trim();
                processVoiceCommand(transcript);
            };
            
            recognition.onerror = function(event) {
                isListening = false;
                document.getElementById('voiceBtn').classList.remove('listening');
                document.getElementById('voiceStatus').textContent = "Voice Navigation";
                
                let errorMessage = "Voice recognition error. ";
                if (event.error === 'no-speech') {
                    errorMessage += "No speech was detected.";
                } else if (event.error === 'audio-capture') {
                    errorMessage += "Microphone is not available.";
                } else if (event.error === 'not-allowed') {
                    errorMessage += "Microphone permission was denied.";
                } else {
                    errorMessage += "Please try again.";
                }
                
                showVoiceNotification(errorMessage, "error");
            };
            
            recognition.onend = function() {
                isListening = false;
                document.getElementById('voiceBtn').classList.remove('listening');
                document.getElementById('voiceStatus').textContent = "Voice Navigation";
            };
            
            return true;
        }
        
        function toggleVoiceRecognition() {
            if (isListening) {
                recognition.stop();
                return;
            }
            
            if (!recognition) {
                if (!initVoiceRecognition()) {
                    return;
                }
            }
            
            try {
                recognition.start();
            } catch (e) {
                showVoiceNotification("Failed to start voice recognition. Please try again.", "error");
            }
        }
        
        function processVoiceCommand(transcript) {
            showVoiceNotification(`You said: "${transcript}"`, "info");
            
            // Try to extract two locations from the transcript
            const words = transcript.toUpperCase().split(/\s+/);
            const foundLocations = [];
            
            // Check for each node name in the transcript (exclude junctions)
            nodes.forEach(node => {
                if (isJunction(node)) return;
                const nodeName = node.toUpperCase();
                if (transcript.toUpperCase().includes(nodeName)) {
                    foundLocations.push(node);
                }
            });
            
            // Also check for partial matches
            if (foundLocations.length < 2) {
                nodes.forEach(node => {
                    if (isJunction(node)) return;
                    const nodeNameParts = node.toUpperCase().split(/[\/\-\s]+/);
                    for (const part of nodeNameParts) {
                        if (part.length > 2 && words.includes(part) && !foundLocations.includes(node)) {
                            foundLocations.push(node);
                            break;
                        }
                    }
                });
            }
            
            if (foundLocations.length >= 2) {
                // Use the first two found locations as from and to
                const from = foundLocations[0];
                const to = foundLocations[1];
                
                document.getElementById('from').value = from;
                document.getElementById('to').value = to;
                
                showVoiceNotification(`Setting route from ${from} to ${to}`, "success");
                
                // Calculate the route after a short delay
                setTimeout(() => {
                    calculateRoute();
                }, 500);
            } else if (foundLocations.length === 1) {
                // Only one location found, set as destination
                const to = foundLocations[0];
                document.getElementById('to').value = to;
                showVoiceNotification(`Set destination to ${to}. Please select your current location.`, "info");
            } else {
                showVoiceNotification("No locations recognized. Please try again with building names.", "error");
            }
        }
        
        function showVoiceNotification(message, type = "info") {
            const notification = document.getElementById('voiceNotification');
            notification.textContent = message;
            notification.className = 'voice-notification show';
            
            if (type === "error") {
                notification.classList.add('error');
            } else if (type === "success") {
                notification.classList.add('success');
            }
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
        
        // Text-to-speech function
        function speak(text, callback) {
            if (!document.getElementById('voiceGuidanceToggle').checked) {
                if (callback) callback();
                return;
            }
            
            if (isSpeaking) {
                speechSynthesis.cancel();
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.9;
            utterance.pitch = 1;
            utterance.volume = 0.8;
            
            utterance.onstart = function() {
                isSpeaking = true;
                document.getElementById('voiceBtn').classList.add('speaking');
            };
            
            utterance.onend = function() {
                isSpeaking = false;
                document.getElementById('voiceBtn').classList.remove('speaking');
                if (callback) callback();
            };
            
            utterance.onerror = function() {
                isSpeaking = false;
                document.getElementById('voiceBtn').classList.remove('speaking');
                if (callback) callback();
            };
            
            speechSynthesis.speak(utterance);
        }
        
        function getDirectionText(currentNode, nextNode) {
            const currentPos = nodePositions[currentNode];
            const nextPos = nodePositions[nextNode];
            
            if (!currentPos || !nextPos) return "";
            
            const dx = nextPos.x - currentPos.x;
            const dy = nextPos.y - currentPos.y;
            
            let direction = "";
            
            // Determine primary direction
            if (Math.abs(dx) > Math.abs(dy)) {
                direction = dx > 0 ? "east" : "west";
            } else {
                direction = dy > 0 ? "south" : "north";
            }
            
            return `Head ${direction} to ${nextNode}.`;
        }
        
        function drawFloorMap() {
            const mapElement = document.getElementById('floorMap');
            mapElement.innerHTML = '';
            
            // Apply zoom transformation
            mapElement.style.transform = `scale(${floorConfig.zoomLevel})`;
            
            // Draw grid
            drawGrid(mapElement);
            
            // Draw connections (edges)
            edges.forEach(edge => {
                const from = nodePositions[edge[0]];
                const to = nodePositions[edge[1]];
                
                if (from && to) {
                    // Draw horizontal segment
                    const hLength = Math.abs(to.x - from.x);
                    if (hLength > 0) {
                        const hSegment = document.createElement('div');
                        hSegment.className = 'connection horizontal';
                        hSegment.style.left = Math.min(from.x, to.x) + 'px';
                        hSegment.style.top = from.y + 'px';
                        hSegment.style.width = hLength + 'px';
                        mapElement.appendChild(hSegment);
                    }
                    
                    // Draw vertical segment
                    const vLength = Math.abs(to.y - from.y);
                    if (vLength > 0) {
                        const vSegment = document.createElement('div');
                        vSegment.className = 'connection vertical';
                        vSegment.style.left = to.x + 'px';
                        vSegment.style.top = Math.min(from.y, to.y) + 'px';
                        vSegment.style.height = vLength + 'px';
                        mapElement.appendChild(vSegment);
                    }
                }
            });
            
            // Draw nodes (hide junction helper nodes)
            nodes.forEach(node => {
                const position = nodePositions[node];
                if (position && !isJunction(node)) {
                    const nodeEl = document.createElement('div');
                    nodeEl.className = 'node';
                    
                    // Add special classes based on node type
                    const type = nodeTypes[node];
                    if (type) {
                        nodeEl.classList.add(type);
                    }
                    
                    nodeEl.style.left = (position.x - 50) + 'px';
                    nodeEl.style.top = (position.y - 30) + 'px';
                    nodeEl.setAttribute('data-id', node);
                    nodeEl.setAttribute('title', node);
                    
                    // Check if this node has an image
                    if (buildingImages[node]) {
                        nodeEl.classList.add('node-with-image');
                        
                        const imageEl = document.createElement('img');
                        imageEl.className = 'building-image';
                        imageEl.src = buildingImages[node];
                        imageEl.alt = node;
                        
                        const nameEl = document.createElement('div');
                        nameEl.className = 'node-name';
                        // Shorten long names for display
                        const displayName = node.length > 15 ? node.substring(0, 15) + '...' : node;
                        nameEl.textContent = displayName;
                        
                        nodeEl.appendChild(imageEl);
                        nodeEl.appendChild(nameEl);
                    } else {
                        const nameEl = document.createElement('div');
                        nameEl.className = 'node-name';
                        // Shorten long names for display
                        const displayName = node.length > 15 ? node.substring(0, 15) + '...' : node;
                        nameEl.textContent = displayName;
                        
                        nodeEl.appendChild(nameEl);
                    }
                    
                    nodeEl.addEventListener('click', () => {
                        // Check if the clicked node is the ENGINEERING BLOCK
                        if (node === "ENGINEERING BLOCK") {
                            // Send a message to the parent frame
                            window.parent.postMessage({ type: 'scroll', target: 'engineering-block-floors' }, '*');
                        } else {
                            showBuildingInfo(node);
                        }
                    });
                    
                    mapElement.appendChild(nodeEl);
                }
            });
            
            // Draw current route if exists
            if (currentPath.length > 0) {
                drawRoute();
            }
            
            // Draw current position if exists
            if (currentPosition) {
                drawPositionMarker();
            }
            
            // Draw destination if exists
            if (destination) {
                drawDestinationMarker();
            }
            
            // Draw avatar if exists
            if (avatar) {
                mapElement.appendChild(avatar);
            }
        }
        
        function drawGrid(mapElement) {
            // Draw vertical grid lines
            for (let x = 0; x <= 1000; x += floorConfig.gridSize) {
                const line = document.createElement('div');
                line.className = 'grid-line vertical';
                line.style.left = x + 'px';
                mapElement.appendChild(line);
            }
            
            // Draw horizontal grid lines
            for (let y = 0; y <= 800; y += floorConfig.gridSize) {
                const line = document.createElement('div');
                line.className = 'grid-line horizontal';
                line.style.top = y + 'px';
                mapElement.appendChild(line);
            }
        }
        
        function drawRoute() {
            const mapElement = document.getElementById('floorMap');
            
            // Draw path segments between each node in the path
            for (let i = 0; i < currentPath.length - 1; i++) {
                const startNode = currentPath[i];
                const endNode = currentPath[i + 1];
                
                const startPos = nodePositions[startNode];
                const endPos = nodePositions[endNode];
                
                if (startPos && endPos) {
                    // Draw horizontal segment
                    const hLength = Math.abs(endPos.x - startPos.x);
                    if (hLength > 0) {
                        const hSegment = document.createElement('div');
                        hSegment.className = 'route-path horizontal';
                        hSegment.style.left = Math.min(startPos.x, endPos.x) + 'px';
                        hSegment.style.top = startPos.y + 'px';
                        hSegment.style.width = hLength + 'px';
                        mapElement.appendChild(hSegment);
                    }
                    
                    // Draw vertical segment
                    const vLength = Math.abs(endPos.y - startPos.y);
                    if (vLength > 0) {
                        const vSegment = document.createElement('div');
                        vSegment.className = 'route-path vertical';
                        vSegment.style.left = endPos.x + 'px';
                        vSegment.style.top = Math.min(startPos.y, endPos.y) + 'px';
                        vSegment.style.height = vLength + 'px';
                        mapElement.appendChild(vSegment);
                    }
                }
            }
            
            // Draw direction markers at each node (except the last one)
            for (let i = 0; i < currentPath.length - 1; i++) {
                const node = currentPath[i];
                const nextNode = currentPath[i + 1];
                
                const pos = nodePositions[node];
                const nextPos = nodePositions[nextNode];
                
                if (pos && nextPos) {
                    const markerEl = document.createElement('div');
                    markerEl.className = 'direction-marker';
                    markerEl.style.left = (pos.x - 12) + 'px';
                    markerEl.style.top = (pos.y - 12) + 'px';
                    markerEl.innerHTML = '<i class="fas fa-arrow-right"></i>';
                    
                    // Determine rotation based on direction to next node
                    const dx = nextPos.x - pos.x;
                    const dy = nextPos.y - pos.y;
                    const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                    markerEl.style.transform = `rotate(${angle}deg)`;
                    
                    mapElement.appendChild(markerEl);
                }
            }
        }
        
        function drawPositionMarker() {
            const mapElement = document.getElementById('floorMap');
            
            const markerEl = document.createElement('div');
            markerEl.className = 'current-position';
            markerEl.style.left = (currentPosition.x - 8) + 'px';
            markerEl.style.top = (currentPosition.y - 8) + 'px';
            
            mapElement.appendChild(markerEl);
        }
        
        function drawDestinationMarker() {
            const mapElement = document.getElementById('floorMap');
            
            const markerEl = document.createElement('div');
            markerEl.className = 'destination';
            markerEl.style.left = (destination.x - 8) + 'px';
            markerEl.style.top = (destination.y - 8) + 'px';
            
            mapElement.appendChild(markerEl);
        }
        
        function createAvatar() {
            const avatarEl = document.createElement('div');
            avatarEl.className = 'avatar';
            avatarEl.innerHTML = '<i class="fas fa-user"></i>';
            avatarEl.style.display = 'none';
            return avatarEl;
        }
        
        function calculateRoute() {
            const from = document.getElementById('from').value;
            const to = document.getElementById('to').value;
            
            if (!from || !to) {
                alert('Please select both current location and destination.');
                return;
            }
            
            if (from === to) {
                alert('You are already at your destination!');
                return;
            }
            
            // Create graph and find path
            const graph = createGraph();
            const path = findShortestPath(graph, from, to);
            
            if (!path) {
                alert('No path found between the selected locations.');
                return;
            }
            
            currentPath = path;
            currentPosition = nodePositions[from];
            destination = nodePositions[to];
            
            // Create avatar if it doesn't exist
            if (!avatar) {
                avatar = createAvatar();
            }
            
            // Position avatar at start
            avatar.style.left = (currentPosition.x - 15) + 'px';
            avatar.style.top = (currentPosition.y - 15) + 'px';
            avatar.style.display = 'flex';
            
            // Redraw map with route
            drawFloorMap();
            
            // Auto-scroll to show the route
            const mapContainer = document.getElementById('mapContainer');
            const startPos = nodePositions[from];
            mapContainer.scrollTo({
                left: startPos.x * floorConfig.zoomLevel - mapContainer.clientWidth / 2,
                top: startPos.y * floorConfig.zoomLevel - mapContainer.clientHeight / 2,
                behavior: 'smooth'
            });
            
            const fromText = from;
            const toText = to;
            
            showVoiceNotification(`Route calculated from ${fromText} to ${toText}`, "success");
        }
        
        function startGuidance() {
            if (currentPath.length < 2) {
                alert('Please calculate a route first.');
                return;
            }
            
            // Stop any existing guidance
            stopGuidance();
            
            currentStep = 0;
            const mapElement = document.getElementById('floorMap');
            
            // Position avatar at start
            const startPos = nodePositions[currentPath[0]];
            avatar.style.left = (startPos.x - 15) + 'px';
            avatar.style.top = (startPos.y - 15) + 'px';
            avatar.style.display = 'flex';
            avatar.style.animation = 'walk 0.5s infinite';
            
            // Announce start of guidance
            const fromText = currentPath[0];
            const toText = currentPath[currentPath.length - 1];
            speak(`Starting navigation from ${fromText} to ${toText}. Follow me.`);
            
            // Start guidance animation
            guidanceInterval = setInterval(() => {
                if (currentStep < currentPath.length - 1) {
                    const currentNode = currentPath[currentStep];
                    const nextNode = currentPath[currentStep + 1];
                    
                    const currentPos = nodePositions[currentNode];
                    const nextPos = nodePositions[nextNode];
                    
                    // Get direction text
                    const directionText = getDirectionText(currentNode, nextNode);
                    
                    // Speak the direction
                    speak(directionText, () => {
                        // Move avatar to next position after speaking
                        avatar.style.left = (nextPos.x - 15) + 'px';
                        avatar.style.top = (nextPos.y - 15) + 'px';
                        
                        // Auto-scroll to follow avatar
                        const mapContainer = document.getElementById('mapContainer');
                        mapContainer.scrollTo({
                            left: nextPos.x * floorConfig.zoomLevel - mapContainer.clientWidth / 2,
                            top: nextPos.y * floorConfig.zoomLevel - mapContainer.clientHeight / 2,
                            behavior: 'smooth'
                        });
                        
                        currentStep++;
                    });
                } else {
                    // Reached destination
                    stopGuidance();
                    const destinationName = currentPath[currentPath.length - 1];
                    speak(`You have arrived at ${destinationName}. Have a great day!`);
                    showVoiceNotification("You have reached your destination!", "success");
                }
            }, 3000); // Increased interval to allow time for speech
        }
        
        function stopGuidance() {
            if (guidanceInterval) {
                clearInterval(guidanceInterval);
                guidanceInterval = null;
            }
            
            if (avatar) {
                avatar.style.animation = 'none';
            }
            
            // Stop any ongoing speech
            if (isSpeaking) {
                speechSynthesis.cancel();
                isSpeaking = false;
                document.getElementById('voiceBtn').classList.remove('speaking');
            }
        }
        
        function zoomIn() {
            if (floorConfig.zoomLevel < 2) {
                floorConfig.zoomLevel += 0.1;
                drawFloorMap();
            }
        }
        
        function zoomOut() {
            if (floorConfig.zoomLevel > 0.5) {
                floorConfig.zoomLevel -= 0.1;
                drawFloorMap();
            }
        }
        
        function resetView() {
            stopGuidance();
            floorConfig.zoomLevel = 0.8;
            currentPath = [];
            currentPosition = null;
            destination = null;
            
            if (avatar) {
                avatar.style.display = 'none';
            }
            
            const mapContainer = document.getElementById('mapContainer');
            mapContainer.scrollTo(0, 0);
            drawFloorMap();
            
            document.getElementById('from').value = '';
            document.getElementById('to').value = '';
        }
        
        // Show building information and floors
        function showBuildingInfo(buildingName) {
            const modal = document.getElementById('buildingModal');
            const buildingInfo = document.getElementById('buildingInfo');
            
            // Populate building info
            buildingInfo.innerHTML = `
                <div class="building-header">
                    <img src="${buildingImages[buildingName] || 'https://via.placeholder.com/200x150/cccccc/000000?text=No+Image'}" 
                         alt="${buildingName}" class="building-image">
                    <h2 class="building-title">${buildingName}</h2>
                </div>
                <p class="building-description">${buildingDescriptions[buildingName] || 'No description available.'}</p>
            `;
            
            // Add floors if available
            if (buildingFloors[buildingName]) {
                const floorsContainer = document.createElement('div');
                floorsContainer.className = 'floors-container';
                floorsContainer.id = `${buildingName.replace(/\s/g, '-')}-floors-container`; // Add a unique ID
                
                buildingFloors[buildingName].forEach(floor => {
                    const floorCard = document.createElement('div');
                    floorCard.className = 'floor-card';
                    floorCard.innerHTML = `
                        <img src="${floor.image}" alt="${floor.name}" class="floor-image">
                        <div class="floor-name">${floor.name}</div>
                        <div class="floor-description">${floor.description}</div>
                    `;
                    
                    // Add click event if specified
                    if (floor.onClick) {
                        floorCard.addEventListener('click', floor.onClick);
                    }
                    
                    floorsContainer.appendChild(floorCard);
                });
                
                buildingInfo.appendChild(floorsContainer);
            }
            
            if (buildingName === "ENGINEERING BLOCK") {
                // Scroll to the floors container instead of opening the modal
                const engineeringFloorsContainer = document.getElementById('ENGINEERING-BLOCK-floors-container');
                if (engineeringFloorsContainer) {
                    engineeringFloorsContainer.scrollIntoView({ behavior: 'smooth' });
                }
            } else {
                // Show the modal for other buildings
                modal.style.display = 'block';
            }
        }
        
        // Show basement floor
        function showBasementFloor() {
            const modal = document.getElementById('buildingModal');
            modal.style.display = 'none';
            
            const basementModal = document.getElementById('basementModal');
            basementModal.style.display = 'block';
            
            // Draw the basement floor map
            drawBasementFloorMap();
        }
        
        // Close basement modal
        function closeBasementModal() {
            const basementModal = document.getElementById('basementModal');
            basementModal.style.display = 'none';
        }
        
        // Create a graph from edges for basement pathfinding
        function basementCreateGraph() {
            const graph = {};
            
            // Add nodes
            basementNodes.forEach(node => {
                graph[node] = [];
            });
            
            // Add edges
            basementEdges.forEach(edge => {
                const [from, to] = edge;
                if (graph[from] && graph[to]) {
                    graph[from].push(to);
                    graph[to].push(from); // Make it bidirectional
                } else {
                    console.error(`Invalid edge: ${from} -> ${to}`);
                }
            });
            
            return graph;
        }
        
        // Draw basement floor map
        function drawBasementFloorMap() {
            const mapElement = document.getElementById('basementMap');
            mapElement.innerHTML = '';
            
            // Apply zoom transformation
            mapElement.style.transform = `scale(${basementConfig.zoomLevel})`;
            
            // Draw connections (edges)
            basementEdges.forEach(edge => {
                const from = basementNodePositions[edge[0]];
                const to = basementNodePositions[edge[1]];
                
                if (from && to) {
                    const dx = to.x - from.x;
                    const dy = to.y - from.y;
                    const length = Math.sqrt(dx * dx + dy * dy);
                    const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                    
                    const connection = document.createElement('div');
                    connection.className = 'basement-connection';
                    connection.style.left = from.x + 'px';
                    connection.style.top = from.y + 'px';
                    connection.style.width = length + 'px';
                    connection.style.transform = `rotate(${angle}deg)`;
                    
                    mapElement.appendChild(connection);
                }
            });
            
            // Draw nodes
            basementNodes.forEach(node => {
                const position = basementNodePositions[node];
                if (position) {
                    const nodeEl = document.createElement('div');
                    nodeEl.className = 'basement-node';
                    
                    // Add special classes for stairs and labs
                    if (node.includes('STAIRS') || node.includes('Stairs')) {
                        nodeEl.classList.add('stairs');
                    } else if (node.includes('LAB') || node.includes('Lab')) {
                        nodeEl.classList.add('lab');
                    }
                    
                    nodeEl.style.left = (position.x - 40) + 'px';
                    nodeEl.style.top = (position.y - 15) + 'px';
                    nodeEl.setAttribute('data-id', node);
                    nodeEl.setAttribute('title', node);
                    
                    const nameEl = document.createElement('div');
                    nameEl.className = 'basement-node-name';
                    // Shorten long names for display
                    const displayName = node.length > 15 ? node.substring(0, 15) + '...' : node;
                    nameEl.textContent = displayName;
                    
                    nodeEl.appendChild(nameEl);
                    
                    nodeEl.addEventListener('click', () => {
                        // Set as destination in basement navigation
                        basementDestination = position;
                        basementDrawFloorMap();
                    });
                    
                    mapElement.appendChild(nodeEl);
                }
            });
            
            // Draw current route if exists
            if (basementCurrentPath.length > 0) {
                basementDrawRoute();
            }
            
            // Draw current position if exists
            if (basementCurrentPosition) {
                basementDrawPositionMarker();
            }
            
            // Draw destination if exists
            if (basementDestination) {
                basementDrawDestinationMarker();
            }
            
            // Draw avatar if exists
            if (basementAvatar) {
                mapElement.appendChild(basementAvatar);
            }
        }
        
        // Draw basement route
        function basementDrawRoute() {
            const mapElement = document.getElementById('basementMap');
            
            // Draw path segments between each node in the path
            for (let i = 0; i < basementCurrentPath.length - 1; i++) {
                const startNode = basementCurrentPath[i];
                const endNode = basementCurrentPath[i + 1];
                
                const startPos = basementNodePositions[startNode];
                const endPos = basementNodePositions[endNode];
                
                if (startPos && endPos) {
                    const dx = endPos.x - startPos.x;
                    const dy = endPos.y - startPos.y;
                    const length = Math.sqrt(dx * dx + dy * dy);
                    const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                    
                    const pathEl = document.createElement('div');
                    pathEl.className = 'basement-route-path';
                    pathEl.style.left = startPos.x + 'px';
                    pathEl.style.top = startPos.y + 'px';
                    pathEl.style.width = length + 'px';
                    pathEl.style.transform = `rotate(${angle}deg)`;
                    
                    mapElement.appendChild(pathEl);
                }
            }
            
            // Draw direction markers at each node (except the last one)
            for (let i = 0; i < basementCurrentPath.length - 1; i++) {
                const node = basementCurrentPath[i];
                const nextNode = basementCurrentPath[i + 1];
                
                const pos = basementNodePositions[node];
                const nextPos = basementNodePositions[nextNode];
                
                if (pos && nextPos) {
                    const markerEl = document.createElement('div');
                    markerEl.className = 'basement-direction-marker';
                    markerEl.style.left = (pos.x - 12) + 'px';
                    markerEl.style.top = (pos.y - 12) + 'px';
                    markerEl.innerHTML = '<i class="fas fa-arrow-right"></i>';
                    
                    // Determine rotation based on direction to next node
                    const dx = nextPos.x - pos.x;
                    const dy = nextPos.y - pos.y;
                    const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                    markerEl.style.transform = `rotate(${angle}deg)`;
                    
                    mapElement.appendChild(markerEl);
                }
            }
        }
        
        // Engineering floors modal helpers and functions
        function showEngFloorModal(key) {
            const data = engFloorData[key];
            if (!data) return;
            engFloorKey = key;
            document.getElementById('engFloorTitle').textContent = `Engineering Block - ${data.name}`;
            document.getElementById('engFloorModal').style.display = 'block';
            const fromSel = document.getElementById('engFrom');
            const toSel = document.getElementById('engTo');
            fromSel.innerHTML = '<option value="">-- Select Current Location --</option>';
            toSel.innerHTML = '<option value="">-- Select Destination --</option>';
            data.nodes.forEach(n => {
                const opt = document.createElement('option');
                opt.value = n; opt.textContent = n;
                fromSel.appendChild(opt.cloneNode(true));
                toSel.appendChild(opt.cloneNode(true));
            });
            engZoom = 0.8; engPath = []; engCurrentPosition = null; engDestination = null; engStep = 0;
            if (!engAvatar) {
                engAvatar = basementCreateAvatar();
                document.getElementById('engFloorMap').appendChild(engAvatar);
            } else {
                engAvatar.style.display = 'none';
            }
            drawEngFloorMap();
        }

        function drawEngFloorMap() {
            if (!engFloorKey) return;
            const { nodes: nfNodes, edges: nfEdges, positions: nfPos } = engFloorData[engFloorKey];
            const mapEl = document.getElementById('engFloorMap');
            mapEl.innerHTML = '';
            mapEl.style.transform = `scale(${engZoom})`;
            nfEdges.forEach(edge => {
                const a = nfPos[edge[0]]; const b = nfPos[edge[1]];
                if (a && b) {
                    const dx = b.x - a.x; const dy = b.y - a.y;
                    const len = Math.sqrt(dx*dx + dy*dy);
                    const ang = Math.atan2(dy, dx) * 180 / Math.PI;
                    const conn = document.createElement('div');
                    conn.className = 'basement-connection';
                    conn.style.left = a.x + 'px';
                    conn.style.top = a.y + 'px';
                    conn.style.width = len + 'px';
                    conn.style.transform = `rotate(${ang}deg)`;
                    mapEl.appendChild(conn);
                }
            });
            nfNodes.forEach(node => {
                const p = nfPos[node];
                if (p) {
                    const nEl = document.createElement('div');
                    nEl.className = 'basement-node';
                    if (node.includes('STAIRS') || node.includes('Stairs')) nEl.classList.add('stairs');
                    else if (node.includes('LAB') || node.includes('Lab')) nEl.classList.add('lab');
                    nEl.style.left = (p.x - 40) + 'px';
                    nEl.style.top = (p.y - 15) + 'px';
                    nEl.setAttribute('title', node);
                    const nameEl = document.createElement('div');
                    nameEl.className = 'basement-node-name';
                    nameEl.textContent = node.length > 15 ? node.substring(0,15) + '...' : node;
                    nEl.appendChild(nameEl);
                    nEl.addEventListener('click', () => {
                        document.getElementById('engTo').value = node;
                        engFloorCalculateRoute();
                    });
                    mapEl.appendChild(nEl);
                }
            });
            if (engPath.length > 0) drawEngRoute();
            if (engCurrentPosition) {
                const cur = document.createElement('div');
                cur.className = 'basement-current-position';
                cur.style.left = (engCurrentPosition.x - 8) + 'px';
                cur.style.top = (engCurrentPosition.y - 8) + 'px';
                mapEl.appendChild(cur);
            }
            if (engDestination) {
                const dst = document.createElement('div');
                dst.className = 'basement-destination';
                dst.style.left = (engDestination.x - 8) + 'px';
                dst.style.top = (engDestination.y - 8) + 'px';
                mapEl.appendChild(dst);
            }
            if (engAvatar) mapEl.appendChild(engAvatar);
        }

        function drawEngRoute() {
            const { positions: nfPos } = engFloorData[engFloorKey];
            const mapEl = document.getElementById('engFloorMap');
            for (let i=0;i<engPath.length-1;i++){
                const s = nfPos[engPath[i]]; const e = nfPos[engPath[i+1]];
                if (s && e){
                    const dx = e.x - s.x; const dy = e.y - s.y;
                    const len = Math.sqrt(dx*dx + dy*dy);
                    const ang = Math.atan2(dy, dx) * 180/Math.PI;
                    const seg = document.createElement('div');
                    seg.className = 'basement-route-path';
                    seg.style.left = s.x + 'px';
                    seg.style.top = s.y + 'px';
                    seg.style.width = len + 'px';
                    seg.style.transform = `rotate(${ang}deg)`;
                    mapEl.appendChild(seg);
                }
            }
        }

        function engFloorCalculateRoute() {
            if (!engFloorKey) return;
            const data = engFloorData[engFloorKey];
            const from = document.getElementById('engFrom').value;
            const to = document.getElementById('engTo').value;
            if (!from || !to) { alert('Please select both current location and destination.'); return; }
            if (from === to) { alert('You are already at your destination!'); return; }
            const graph = (function(){ const g={}; data.nodes.forEach(n=>g[n]=[]); data.edges.forEach(([a,b])=>{ if(g[a]&&g[b]){g[a].push(b);g[b].push(a);} }); return g; })();
            const path = findShortestPath(graph, from, to);
            if (!path) { alert('No path found between the selected locations.'); return; }
            engPath = path;
            engCurrentPosition = data.positions[from];
            engDestination = data.positions[to];
            if (!engAvatar) { engAvatar = basementCreateAvatar(); }
            engAvatar.style.left = (engCurrentPosition.x - 15) + 'px';
            engAvatar.style.top = (engCurrentPosition.y - 15) + 'px';
            engAvatar.style.display = 'flex';
            drawEngFloorMap();
            const cont = document.getElementById('engFloorContainer');
            const startPos = data.positions[from];
            cont.scrollTo({ left: startPos.x * engZoom - cont.clientWidth/2, top: startPos.y * engZoom - cont.clientHeight/2, behavior: 'smooth' });
            showVoiceNotification(`Route calculated from ${from} to ${to}`, 'success');
        }

        function engFloorStartGuidance() {
            if (engPath.length < 2) { alert('Please calculate a route first.'); return; }
            engFloorStopGuidance();
            engStep = 0;
            const data = engFloorData[engFloorKey];
            const startPos = data.positions[engPath[0]];
            engAvatar.style.left = (startPos.x - 15) + 'px';
            engAvatar.style.top = (startPos.y - 15) + 'px';
            engAvatar.style.display = 'flex';
            engAvatar.style.animation = 'walk 0.5s infinite';
            const fromText = engPath[0]; const toText = engPath[engPath.length-1];
            speak(`Starting navigation from ${fromText} to ${toText}. Follow me.`);
            engGuidanceInterval = setInterval(()=>{
                if (engStep < engPath.length - 1){
                    const cur = engPath[engStep]; const nxt = engPath[engStep+1];
                    const npos = data.positions[nxt];
                    const dirText = (function(){
                        const cpos = data.positions[cur];
                        if (!cpos||!npos) return '';
                        const dx = npos.x - cpos.x; const dy = npos.y - cpos.y;
                        let d = Math.abs(dx)>Math.abs(dy) ? (dx>0?'east':'west') : (dy>0?'south':'north');
                        if (nxt.includes('STAIRS')||nxt.includes('Stairs')) return `Proceed to the ${nxt}.`;
                        if (nxt.includes('LAB')||nxt.includes('Lab')) return `Head ${d} to the ${nxt}.`;
                        return `Go ${d} to ${nxt}.`;
                    })();
                    speak(dirText, ()=>{
                        engAvatar.style.left = (npos.x - 15) + 'px';
                        engAvatar.style.top = (npos.y - 15) + 'px';
                        const cont = document.getElementById('engFloorContainer');
                        cont.scrollTo({ left: npos.x * engZoom - cont.clientWidth/2, top: npos.y * engZoom - cont.clientHeight/2, behavior: 'smooth' });
                        engStep++;
                    });
                } else {
                    engFloorStopGuidance();
                    const destName = engPath[engPath.length-1];
                    speak(`You have arrived at ${destName}. Have a great day!`);
                    showVoiceNotification('You have reached your destination!','success');
                }
            }, 3000);
        }

        function engFloorStopGuidance() {
            if (engGuidanceInterval){ clearInterval(engGuidanceInterval); engGuidanceInterval = null; }
            if (engAvatar) engAvatar.style.animation = 'none';
            if (isSpeaking) { speechSynthesis.cancel(); isSpeaking = false; document.getElementById('voiceBtn').classList.remove('speaking'); }
        }

        function engFloorZoomIn(){ if (engZoom < 2){ engZoom += 0.1; drawEngFloorMap(); } }
        function engFloorZoomOut(){ if (engZoom > 0.5){ engZoom -= 0.1; drawEngFloorMap(); } }
        function engFloorResetView(){ engFloorStopGuidance(); engZoom=0.8; engPath=[]; engCurrentPosition=null; engDestination=null; if (engAvatar) engAvatar.style.display='none'; const c=document.getElementById('engFloorContainer'); c.scrollTo(0,0); drawEngFloorMap(); document.getElementById('engFrom').value=''; document.getElementById('engTo').value=''; }
        
        // Draw basement position marker
        function basementDrawPositionMarker() {
            const mapElement = document.getElementById('basementMap');
            
            const markerEl = document.createElement('div');
            markerEl.className = 'basement-current-position';
            markerEl.style.left = (basementCurrentPosition.x - 8) + 'px';
            markerEl.style.top = (basementCurrentPosition.y - 8) + 'px';
            
            mapElement.appendChild(markerEl);
        }
        
        // Draw basement destination marker
        function basementDrawDestinationMarker() {
            const mapElement = document.getElementById('basementMap');
            
            const markerEl = document.createElement('div');
            markerEl.className = 'basement-destination';
            markerEl.style.left = (basementDestination.x - 8) + 'px';
            markerEl.style.top = (basementDestination.y - 8) + 'px';
            
            mapElement.appendChild(markerEl);
        }
        
        // Create basement avatar
        function basementCreateAvatar() {
            const avatarEl = document.createElement('div');
            avatarEl.className = 'basement-avatar';
            avatarEl.innerHTML = '<i class="fas fa-user"></i>';
            avatarEl.style.display = 'none';
            return avatarEl;
        }
        
        // Basement zoom functions
        function basementZoomIn() {
            if (basementConfig.zoomLevel < 2) {
                basementConfig.zoomLevel += 0.1;
                drawBasementFloorMap();
            }
        }
        
        function basementZoomOut() {
            if (basementConfig.zoomLevel > 0.5) {
                basementConfig.zoomLevel -= 0.1;
                drawBasementFloorMap();
            }
        }
        
        // Basement guidance functions
        function basementStartGuidance() {
            // Implementation for basement guidance
            alert("Basement guidance started");
        }
        
        function basementStopGuidance() {
            // Implementation for stopping basement guidance
            alert("Basement guidance stopped");
        }
        
        function basementResetView() {
            basementConfig.zoomLevel = 0.8;
            basementCurrentPath = [];
            basementCurrentPosition = null;
            basementDestination = null;
            
            if (basementAvatar) {
                basementAvatar.style.display = 'none';
            }
            
            const basementContainer = document.getElementById('basementContainer');
            basementContainer.scrollTo(0, 0);
            drawBasementFloorMap();
        }
        
        // Initialize on page load
        window.onload = function() {
            // Populate dropdowns
            const fromSelect = document.getElementById('from');
            const toSelect = document.getElementById('to');
            
            nodes.forEach(node => {
                if (isJunction(node)) return; // exclude junctions from dropdowns
                // Add to dropdowns
                const option = document.createElement('option');
                option.value = node;
                option.textContent = node;
                fromSelect.appendChild(option.cloneNode(true));
                toSelect.appendChild(option.cloneNode(true));
            });
            
            // Create avatar
            avatar = createAvatar();
            document.getElementById('floorMap').appendChild(avatar);
            
            // Create basement avatar
            basementAvatar = basementCreateAvatar();
            document.getElementById('basementMap').appendChild(basementAvatar);
            
            // Initialize voice recognition
            initVoiceRecognition();
            
            // Draw the floor map
            drawFloorMap();
            
            // Close modal when clicking on X
            document.getElementById('closeModal').addEventListener('click', function() {
                document.getElementById('buildingModal').style.display = 'none';
            });
            
            // Close basement modal when clicking on X
            document.getElementById('closeBasement').addEventListener('click', function() {
                document.getElementById('basementModal').style.display = 'none';
            });
            
            // Close engineering floors modal when clicking on X
            document.getElementById('closeEngFloor').addEventListener('click', function() {
                document.getElementById('engFloorModal').style.display = 'none';
            });
            
            // Close modal when clicking outside
            window.addEventListener('click', function(event) {
                if (event.target == document.getElementById('buildingModal')) {
                    document.getElementById('buildingModal').style.display = 'none';
                }
                if (event.target == document.getElementById('basementModal')) {
                    document.getElementById('basementModal').style.display = 'none';
                }
                if (event.target == document.getElementById('engFloorModal')) {
                    document.getElementById('engFloorModal').style.display = 'none';
                }
            });
        };
    </script>
</body>SS
</html>
